/**
 * If browser back button was used, flush cache
 * This ensures that user will always see an accurate, up-to-date view based on their state
 * https://stackoverflow.com/questions/8788802/prevent-safari-loading-from-cache-when-back-button-is-clicked
 */
(function () {
  window.onpageshow = function (event) {
    if (event.persisted) {
      window.location.reload();
    }
  };
})();

$(".top").on("click", function () {
  $("html, body").animate({ scrollTop: 0 }, "slow");
});

$(".slick-container").slick({
  dots: false,
  arrrow: false,
  infinite: true,
  speed: 300,
  slidesToShow: 3,
  slidesToScroll: 1,
  autoplay: true,
  autoplaySpeed: 5000,
  responsive: [
    {
      breakpoint: 1024,
      settings: {
        slidesToShow: 3,
        slidesToScroll: 3,
        infinite: true,
        dots: true,
      },
    },
    {
      breakpoint: 775,
      settings: {
        slidesToShow: 2,
        slidesToScroll: 2,
      },
    },
    {
      breakpoint: 480,
      settings: {
        slidesToShow: 1,
        slidesToScroll: 1,
      },
    },
  ],
});

$(".step-awnser button").on("click", function () {
  $(".button_clicked").removeClass("button_clicked");
  $(this).addClass("button_clicked");
});

$(".checkout-button").on("click", function () {
  $(".selected").removeClass("selected");
  $(this).addClass("selected");
  $(".direct-checkout-link a").attr("href", `/cart/${this.id}:1`);
});

$(".next").on("click", function () {
  this.disabled = true;
  let parent = $(this).parents(".step-container");
  this.parentElement.dataset[
    Object.keys(this.parentElement.dataset)[0]
  ] = this.textContent;
  if (parent.next().length) {
    $(".current-step")
      .addClass("step-completed")
      .removeClass("current-step")
      .next()
      .addClass("current-step");
    parent.fadeOut("slow", function () {
      parent.next().removeClass("d-none");
    });
  } else {
    console.log("no next");
    // window.location = '/'
  }
});

$('.products-names p:not(".actual")').each(function (i) {
  $(this).css({ order: `${i * 3}` });
});

$(".direct-checkout-link a").on("click", function (e) {
  if ($(this).attr("href") === "#") {
    e.preventDefault();
    alert("please select a package before continue");
  }
});

$("#modal-button").on("click", function () {
  window.location = this.href;
  $(".modal-overlay").addClass("d-none");
  $(".modal-bullet-point").html("<ul></ul>");
});

$(".open-modal").on("click", function () {
  let awnsers = getData();
  let recommended = getRecommended(awnsers);
  if (recommended) {
    $(".recommended").text(recommended.name);
    $("#modal-button").attr("href", recommended.link);
    $(".modal-overlay").attr("id", recommended.id).removeClass("d-none");
    $(".modal-img").attr("src", recommended.img);
    if (recommended.bullets) {
      $(".modal-bullet-points ul").append(
        recommended.bullets.map((e) => `<li>${e}</li>`).join(" ")
      );
    } else {
      $(".modal-bullet-points").append(recommended.description);
    }
  }
});

$(".buy-now-container").on("click", function (e) {
  e.preventDefault();
  $("html, body").animate({ scrollTop: 0 }, "slow");
});
function getRecommended(object) {
  const { question1, question2, question3 } = object;
  let product = "";
  let name = "";
  let shopifyProduct = {};

  switch (true) {
    case question1 == "yes" && question2 == "yes" && question3 == "yes":
      name = "Premium Care Package";
      shopifyProduct = products.find((e) => e.title.includes(name));
      product = {
        id: shopifyProduct.handle,
        link: "/products/" + shopifyProduct.handle,
        name,
        img: shopifyProduct.featured_image,
        bullets: shopifyProduct.description.match(/[A-Z]{3}(?:(?!<).)*/g),
      };
      break;
    case question1 == "yes" && question2 == "yes":
      name = "Joint Support Care Package";
      shopifyProduct = products.find((e) => e.title.includes(name));
      product = {
        id: shopifyProduct.handle,
        link: "/products/" + shopifyProduct.handle,
        name,
        img: shopifyProduct.featured_image,
        bullets: shopifyProduct.description.match(/[A-Z]{3}(?:(?!<).)*/g),
      };
      break;
    case question1 == "yes" && question3 == "yes":
      name = "Collagen Care Package";
      shopifyProduct = products.find((e) => e.title.includes(name));
      product = {
        id: shopifyProduct.handle,
        link: "/products/" + shopifyProduct.handle,
        name,
        img: shopifyProduct.featured_image,
        bullets: shopifyProduct.description.match(/[A-Z]{3}(?:(?!<).)*/g),
      };
      break;
    case question1 == "yes":
      name = "Joint Support";
      shopifyProduct = products.find((e) => e.title.includes(name));
      product = {
        id: shopifyProduct.handle,
        link: "/products/" + shopifyProduct.handle,
        name,
        img: shopifyProduct.featured_image,
        description: shopifyProduct.description,
      };
      break;
    case question2 == "yes":
      name = "Ultra Vitamins+";
      shopifyProduct = products.find((e) => e.title.includes(name));
      product = {
        id: shopifyProduct.handle,
        link: "/products/" + shopifyProduct.handle,
        name,
        img: shopifyProduct.featured_image,
        description: shopifyProduct.description,
      };
      break;
    case question3 == "yes":
      name = "Collagen V12";
      shopifyProduct = products.find((e) => e.title.includes(name));
      product = {
        id: shopifyProduct.handle,
        link: "/products/" + shopifyProduct.handle,
        name,
        img: shopifyProduct.featured_image,
        description: shopifyProduct.description,
      };
      break;
    default:
      window.location = "/";
      break;
  }
  return product;
}

function getData() {
  let awnsers = {};
  $(".step-awnser").each(function () {
    let key = Object.keys($(this).data())[0];
    awnsers[key] = $(this).data(key);
  });
  return awnsers;
}

if ($(".buy-now-container").length && location.pathname === "/") {
  $(".buy-now-container").hide();
}

if ($(".buy-now-container").length && location.pathname === "/") {
  $(".buy-now-container").hide();
}

if ($(".bottle-container").length && location.pathname === "/pages/questions") {
  $(".bottle-container").hide();
}
